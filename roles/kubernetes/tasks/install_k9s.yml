---
- name: Get latest k9s version
  when: ansible_facts['os_family'] != 'Darwin'
  ansible.builtin.uri:
    url: https://api.github.com/repos/derailed/k9s/releases/latest
    return_content: true
  register: kubernetes_k9s_release
- name: Set k9s download URL
  when: ansible_facts['os_family'] != 'Darwin'
  ansible.builtin.set_fact:
    k9s_download_url: >-
      https://github.com/derailed/k9s
      /releases/download/{{ kubernetes_k9s_release.json.tag_name }}
      /k9s_{{ kubernetes_os_map[ansible_facts['os_family']] | trim }}_amd64.tar.gz
- name: Download and extract k9s
  when: ansible_facts['os_family'] != 'Darwin'
  ansible.builtin.unarchive:
    src: "{{ k9s_download_url | trim | replace(' ', '') }}"
    dest: /tmp/
    remote_src: true
  environment:
    PATH: "/usr/local/opt/gnu-tar/libexec/gnubin:{{ ansible_env.PATH | default('') }}"
- name: Move k9s binary to /usr/local/bin
  when: ansible_facts['os_family'] != 'Darwin'
  become: true
  ansible.builtin.copy:
    remote_src: true
    src: /tmp/k9s
    dest: /usr/local/bin/k9s
    mode: "0777"
- name: Install k9s on macOS
  when: ansible_facts['os_family'] == 'Darwin'
  homebrew:
    name: k9s
    state: present
- name: Generate the k9s zsh completion
  ansible.builtin.command: /usr/local/bin/k9s completion zsh
  register: k9s_zsh_completion
  when: ansible_facts['os_family'] != 'Darwin'
- name: Write the k9s zsh completion to the appropriate location
  ansible.builtin.copy:
    content: "{{ k9s_zsh_completion.stdout }}"
    dest: "{{ ansible_env.HOME }}/.zsh/completions/_k9s"
    mode: "0777"
  when:
    - k9s_zsh_completion.stdout is defined and k9s_zsh_completion.stdout != ""
    - ansible_facts['os_family'] != 'Darwin'
