---
- name: Ensure onepassword zsh completion is generated
  ansible.builtin.command: op completion zsh
  register: onepassword_zsh_completion
  when: ansible_os_family != "Darwin"
- name: Configure onepassword completion for zsh
  ansible.builtin.blockinfile:
    path: "{{ ansible_env.HOME }}/.zsh/completions/_onepassword"
    create: true
    mode: "0700"
    content: "{{ onepassword_zsh_completion.stdout }}"
  when: ansible_os_family != "Darwin"
- name: Detect the direnv plugins directory
  ansible.builtin.stat:
    path: "{{ ansible_env.HOME }}/.config/direnv/lib"
  register: onepassword_direnv_lib_dir
- name: Copy the op direnv extension
  ansible.builtin.copy:
    src: op.sh
    dest: "{{ ansible_env.HOME }}/.config/direnv/lib/op.sh"
    mode: "0700"
  when: onepassword_direnv_lib_dir.stat.exists
