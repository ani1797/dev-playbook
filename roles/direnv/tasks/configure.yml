---
- name: Ensure direnv config directory exists
  ansible.builtin.file:
    path: "{{ direnv_config_dir }}"
    state: directory
    mode: '0700'
    owner: "{{ ansible_user_id }}"
    group: "{{ ansible_user_gid }}"
- name: Ensure direnv lib directory exists
  ansible.builtin.file:
    path: "{{ direnv_config_dir }}/lib"
    state: directory
    mode: '0700'
- name: Ensure direnv.toml is present
  ansible.builtin.template:
    src: direnv.toml.j2
    dest: "{{ direnv_config_dir }}/direnv.toml"
    mode: '0600'
- name: Ensure global direnvrc is created
  ansible.builtin.copy:
    content: |
      ## This configuration is applied to all directories! Be careful what you put here.
      ## See https://direnv.net/ for more information.
      ## This file is managed by Ansible, local changes will be overwritten.

      # Load .env if it exists
      dotenv_if_exists
    dest: "{{ direnv_config_dir }}/direnvrc"
    mode: '0700'
- name: Configure direnv completion for zsh
  ansible.builtin.blockinfile:
    marker: "# {mark} direnv configuration"
    path: "{{ direnv_shell_config_file }}"
    create: true
    mode: '0700'
    content: |
      if type direnv &> /dev/null
      then
        eval "$(direnv hook zsh)"
      fi
